name: Scrape NEPSE Today Price

on:
  push:
    branches:
      - main
  schedule:
    # Run every 30 minutes from 11:00 AM to 4:00 PM NPT (UTC+5:45)
    # 11:00 AM NPT is 05:15 UTC
    # 04:00 PM NPT is 10:15 UTC
    - cron: '*/30 5-10 * * 1-5'
  workflow_dispatch: # Allow manual trigger

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        pip install -r scripts/nepse-scraper/requirements.txt

    - name: Run Market Scraper
      run: |
        mkdir -p data
        python scripts/nepse-scraper/scraper.py
    
    - name: Commit and push changes
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git pull --rebase --autostash
        git add data/nepse_data.json
        git commit -m "Update Market Data: $(date)" || echo "No changes to commit"
        git push
